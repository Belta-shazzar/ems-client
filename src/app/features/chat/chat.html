<div class="flex h-[calc(100vh-4rem)] bg-white dark:bg-gray-900">
  <!-- Sidebar -->
  <div
    class="w-80 border-r border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 flex flex-col"
  >
    <div class="p-4 border-b border-gray-200 dark:border-gray-700">
      <h2
        class="text-lg font-semibold text-gray-900 dark:text-white flex items-center"
      >
        <lucide-angular name="users" class="w-5 h-5 mr-2" />
        Employees
      </h2>
    </div>

    <div class="flex-1 overflow-y-auto">
      <div
        *ngFor="let employee of employees"
        (click)="selectUser(employee)"
        [ngClass]="{
          'bg-blue-50 dark:bg-blue-900/30': selectedUser?.id === employee.id
        }"
        class="p-4 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer flex items-center"
      >
        <div class="relative">
          <div
            class="w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center text-gray-600 dark:text-gray-300 font-medium"
          >
            {{ employee.firstName.charAt(0) }}{{ employee.lastName.charAt(0) }}
          </div>
          <span
            *ngIf="isUserOnline(employee.id)"
            class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white dark:border-gray-800"
          ></span>
        </div>

        <div class="ml-3">
          <p class="text-sm font-medium text-gray-900 dark:text-white">
            {{ employee.firstName }} {{ employee.lastName }}
          </p>
          <p class="text-xs text-gray-500 dark:text-gray-400">
            {{ employee.role }}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat area -->
  <div class="flex-1 flex flex-col">
    <!-- Chat header -->
    <div
      *ngIf="selectedUser"
      class="p-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 flex items-center"
    >
      <div class="relative">
        <div
          class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center text-blue-600 dark:text-blue-400 font-medium"
        >
          {{ selectedUser.firstName.charAt(0)
          }}{{ selectedUser.lastName.charAt(0) }}
        </div>
        <span
          *ngIf="isUserOnline(selectedUser.id)"
          class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white dark:border-gray-900"
        ></span>
      </div>

      <div class="ml-3">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
          {{ selectedUser.firstName }} {{ selectedUser.lastName }}
        </h2>
        <p class="text-sm text-gray-500 dark:text-gray-400">
          {{ isUserOnline(selectedUser.id) ? "Online" : "Offline" }}
        </p>
      </div>
    </div>

    <!-- Messages -->
    <div #messagesContainer class="flex-1 overflow-y-auto p-4 space-y-4">
      <div
        *ngFor="let message of messages"
        [class.justify-end]="message.senderId === currentUser?.userId"
        class="flex"
      >
        <div
          *ngIf="message.senderId !== currentUser?.userId"
          class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center text-gray-600 dark:text-gray-300 font-medium mr-2 shrink-0"
        >
          {{ getInitials(message.senderName) }}
        </div>

        <!-- FIXED MESSAGE BUBBLE -->
        <div
          class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg"
          [ngClass]="{
            'bg-blue-100 text-blue-800 dark:bg-blue-900/50 ml-auto':
              message.senderId === currentUser?.userId,
            'bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200':
              message.senderId !== currentUser?.userId
          }"
        >
          <p class="text-sm">{{ message.content }}</p>

          <p
            class="text-xs mt-1 text-right"
            [ngClass]="{
              'text-blue-600 dark:text-blue-400':
                message.senderId === currentUser?.userId,
              'text-gray-500 dark:text-gray-400':
                message.senderId !== currentUser?.userId
            }"
          >
            {{ message.timestamp | date : "shortTime" }}
          </p>
        </div>
      </div>
    </div>

    <!-- Message input -->
    <div
      *ngIf="selectedUser"
      class="p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900"
    >
      <form (ngSubmit)="sendMessage()" class="flex space-x-2">
        <input
          type="text"
          [(ngModel)]="newMessage"
          name="newMessage"
          placeholder="Type a message..."
          class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-800 dark:text-white"
        />
        <button
          type="submit"
          [disabled]="!newMessage.trim()"
          class="p-2 rounded-full bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <lucide-angular name="send" class="w-5 h-5" />
        </button>
      </form>
    </div>

    <!-- No user selected -->
    <div
      *ngIf="!selectedUser"
      class="flex-1 flex flex-col items-center justify-center text-center p-8"
    >
      <div
        class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center text-blue-600 dark:text-blue-400 mb-4"
      >
        <lucide-angular name="message-square" class="w-8 h-8" />
      </div>

      <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-1">
        Select a conversation
      </h3>
      <p class="text-gray-500 dark:text-gray-400 max-w-md">
        Choose an employee from the sidebar to start chatting. You can only
        message employees with lower or equal roles.
      </p>
    </div>
  </div>
</div>
